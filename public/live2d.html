<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Live2d</title>
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.x/dist/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/RaSan147/pixi-live2d-display@v0.5.0-ls-7/dist/index.min.js"></script>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        overflow: hidden;
      }

      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: transparent;
      }

      #canvas-container {
        width: 100%;
        height: 100vh;
      }

      canvas {
        width: 100%;
        height: 100%;
        image-rendering: -webkit-optimize-contrast; /* Webkit系ブラウザでの画質向上 */
        image-rendering: crisp-edges;              /* 一般的な画質向上 */
      }

      #live2d {
        position: absolute;
        width: 300px;
        height: 500px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }

      .controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(255, 255, 255, 0.8);
        padding: 10px;
        border-radius: 5px;
        z-index: 1000;
      }

      .control-group {
        margin: 10px 0;
      }

      .control-group input[type="range"] {
        width: 200px;
        margin: 0 10px;
      }

      label {
        display: block;
        margin-bottom: 5px;
      }
    </style>
  </head>
  <body>
    <div id="canvas-container">
      <canvas id="canvas"></canvas>
    </div>
    
    <div class="controls">
      <div class="control-group">
        <button id="startTalkingBtn">会話開始</button>
        <button id="stopTalkingBtn">会話停止</button>
      </div>
      <div class="control-group">
        <label for="scaleSlider">モデルサイズ: <span id="scaleValue">0.35</span></label>
        <input type="range" id="scaleSlider" min="0.1" max="2.0" step="0.05" value="0.35">
      </div>
      <div class="control-group">
        <label for="xSlider">左右位置: <span id="xValue">0</span></label>
        <input type="range" id="xSlider" min="-500" max="500" step="10" value="0">
      </div>
      <div class="control-group">
        <label for="ySlider">上下位置: <span id="yValue">0</span></label>
        <input type="range" id="ySlider" min="-500" max="500" step="10" value="300">
      </div>
    </div>

    <script>
      window.PIXI = PIXI;
      let live2DModel = null;
      let talkingInterval = null;

      // PIXI.jsアプリケーションの初期化を修正
      const app = new PIXI.Application({
        view: document.getElementById('canvas'),
        transparent: true,
        autoStart: true,
        width: window.innerWidth,
        height: window.innerHeight,
        resolution: window.devicePixelRatio || 1, // デバイスのピクセル比に合わせる
        autoDensity: true,                        // 高DPIディスプレイに対応
        antialias: true,                          // アンチエイリアスを有効化
        powerPreference: "high-performance"       // パフォーマンスを優先
      });

      // スライダー要素の取得
      const scaleSlider = document.getElementById('scaleSlider');
      const xSlider = document.getElementById('xSlider');
      const ySlider = document.getElementById('ySlider');
      
      // 値表示要素の取得
      const scaleValue = document.getElementById('scaleValue');
      const xValue = document.getElementById('xValue');
      const yValue = document.getElementById('yValue');

      // モデルの位置を更新する関数
      function updateModelPosition() {
        if (live2DModel) {
          const centerX = app.screen.width / 2;
          const centerY = app.screen.height / 2;
          const offsetX = parseInt(xSlider.value);
          const offsetY = parseInt(ySlider.value);
          
          live2DModel.position.set(
            centerX + offsetX,
            centerY + offsetY
          );
          
          xValue.textContent = offsetX;
          yValue.textContent = offsetY;
        }
      }

      // スケールの変更処理
      scaleSlider.addEventListener('input', (e) => {
        if (live2DModel) {
          const newScale = parseFloat(e.target.value);
          live2DModel.scale.set(newScale);
          scaleValue.textContent = newScale.toFixed(2);
        }
      });

      // X位置の変更処理
      xSlider.addEventListener('input', updateModelPosition);

      // Y位置の変更処理
      ySlider.addEventListener('input', updateModelPosition);

      // モデルの読み込みを修正
      (async function loadModel() {
        try {
          const modelPath = 'https://cdn.jsdelivr.net/gh/guansss/pixi-live2d-display/test/assets/haru/haru_greeter_t03.model3.json';
          
          // モデル読み込み時のオプションを追加
          live2DModel = await PIXI.live2d.Live2DModel.from(modelPath, {
            // モデルのクオリティ設定
            autoUpdate: true,
            motionPreload: "ALL",    // すべてのモーションを事前読み込み
            idleMotionPriority: 1,   // アイドルモーションの優先度
            expressionPreload: true  // 表情を事前読み込み
          });
          
          // 初期スケールの設定
          const initialScale = parseFloat(scaleSlider.value);
          live2DModel.scale.set(initialScale);
          
          // 初期位置の設定
          live2DModel.anchor.set(0.5, 0.5);
          updateModelPosition();
          
          // モデルのスケールと解像度を調整
          const scale = 0.35;
          live2DModel.scale.set(scale);
          live2DModel.filters = []; // 必要に応じてフィルターを追加可能
          
          app.stage.addChild(live2DModel);
          
          // デバッグ用：モデルが読み込まれたことを確認
          console.log('モデルが読み込まれました:', live2DModel);
          
          // インタラクションの設定
          live2DModel.on('hit', (hitAreas) => {
            console.log('Hit areas:', hitAreas);
          });
        } catch (error) {
          console.error('モデルの読み込みに失敗しました:', error);
          console.error('エラーの詳細:', error.message);
        }
      })();

      // ウィンドウリサイズ時の処理を修正
      window.addEventListener('resize', () => {
        if (live2DModel) {
          updateModelPosition();
        }
      });

      // 会話アニメーション開始（lipsync対応版）
      document.getElementById('startTalkingBtn').addEventListener('click', () => {
        if (live2DModel) {
          // 音声ファイルのURLを指定
          const audioUrl = 'https://cdn.jsdelivr.net/gh/RaSan147/pixi-live2d-display@v1.0.3/playground/test.mp3';
          
          // lipsyncを開始
          live2DModel.speak(audioUrl, {
            volume: 1.0,
            expression: null, // 必要に応じて表情インデックスを指定
            crossOrigin: "anonymous",
            onFinish: () => {
              console.log("音声再生完了");
            },
            onError: (err) => {
              console.error("エラー:", err);
            }
          });
        }
      });

      // 会話アニメーション停止
      document.getElementById('stopTalkingBtn').addEventListener('click', () => {
        if (live2DModel) {
          live2DModel.stopSpeaking();
        }
      });

      // モーションとlipsyncを組み合わせる例
      function playMotionWithVoice() {
        if (live2DModel) {
          const audioUrl = 'path/to/your/audio.mp3';
          live2DModel.motion("idle", 0, 3, {
            sound: audioUrl,
            volume: 1.0,
            expression: 0,
            crossOrigin: "anonymous",
            onFinish: () => {
              console.log("モーションと音声再生完了");
            }
          });
        }
      }
    </script>
  </body>
</html> 